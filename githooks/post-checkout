#!/bin/bash
# A simple post-checkout hook to update submodules on branch switches.

# If there's no .gitmodules file in this branch, skip the hook.
if [ ! -f .gitmodules ]; then
    echo "No .gitmodules file found; skipping submodule update."
    exit 0
fi

# Only run when the checkout is due to a branch switch (third parameter equals "1")
if [ "$3" != "1" ]; then
    exit 0
fi

echo "Branch switch detected: Updating submodules..."

# Deinitialize all submodules, suppressing any errors
git submodule deinit -f . 2>/dev/null

# Retrieve the list of submodule paths from .gitmodules
submodules=$(git config -f .gitmodules --get-regexp '^submodule\..*\.path$' | awk '{print $2}')

# Loop over each submodule path and remove it entirely
for submodule_path in $submodules; do
    if [ -d "$submodule_path" ]; then
        echo "Removing $submodule_path entirely..."
        chmod -R u+w "$submodule_path"
        rm -rf "$submodule_path"
    fi
done

# Reinitialize and update submodules
git submodule update --init --recursive
echo "Submodules updated."
