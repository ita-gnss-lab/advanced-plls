#!/bin/bash
# A simple post-checkout hook to update submodules on branch switches.

# If there's no .gitmodules file in this branch, skip the hook.
if [ ! -f .gitmodules ]; then
    echo "No .gitmodules file found; skipping submodule update."
    exit 0
fi

# Only run when the checkout is due to a branch switch (third parameter equals "1")
if [ "$3" != "1" ]; then
    exit 0
fi

echo "Branch switch detected: Updating submodules..."

# Deinitialize all submodules, suppressing errors if config files are missing.
git submodule deinit -f . 2>/dev/null

# Retrieve the list of submodule paths from .gitmodules
submodules=$(git config -f .gitmodules --get-regexp '^submodule\..*\.path$' | awk '{print $2}')

# Loop over each submodule path and clean it up
for submodule_path in $submodules; do
    if [ -d "$submodule_path" ]; then
        echo "Cleaning up and removing $submodule_path..."
        # Change permissions recursively to ensure all files are writable.
        chmod -R u+w "$submodule_path"
        # Remove all files (including hidden ones)
        rm -rf "$submodule_path"/.[!.]* "$submodule_path"/*
        # Optionally, force a clean to remove any untracked files:
        (cd "$submodule_path" && git clean -fdx 2>/dev/null)
        # Finally, remove the directory itself
        rm -rf "$submodule_path"
    fi
done

# Reinitialize and update submodules
git submodule update --init --recursive
echo "Submodules updated."
